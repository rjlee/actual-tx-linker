name: Docker build

on:
  workflow_dispatch:
  workflow_run:
    workflows: ['Release']
    types: [completed]
  schedule:
    - cron: '0 23 * * *' # Nightly

jobs:
  docker:
    uses: rjlee/actual-auto-ci/.github/workflows/docker-api-matrix.yml@v1
    with:
      image-name: ghcr.io/${{ github.repository }}
      platforms: linux/amd64
      majors-window: 3
      dockerfile: Dockerfile
      context: .

      - name: Prepare tag manifest
        run: |
          printf "api-%s\napi-%s\napi-%s\n" \
            "${{ matrix.ver }}" \
            "${{ steps.aliases.outputs.minor }}" \
            "${{ steps.aliases.outputs.major }}" \
            > tags-${{ matrix.ver }}.txt

      - name: Upload per-version manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: tags-${{ matrix.ver }}
          path: tags-${{ matrix.ver }}.txt
          if-no-files-found: error

  aggregate-manifest:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download tag artifacts only
        uses: actions/download-artifact@v4
        with:
          path: tags
          pattern: tags-*
          merge-multiple: true

      - name: Combine manifests
        run: |
          set -euo pipefail
          if ! ls tags/tags-*.txt >/dev/null 2>&1; then
            echo "No tag artifacts found to combine; skipping." >&2
            exit 0
          fi
          cat tags/tags-*.txt | sort -u > tags.txt
          echo "Combined manifest:" && cat tags.txt

      - name: Upload combined manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: tags
          path: tags.txt

      - name: Upload combined manifest to latest release (best-effort)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REL_ID=$(gh api repos/${{ github.repository }}/releases \
            --jq 'map(select(.draft==false and .prerelease==false)) | sort_by(.created_at) | last | .id' || echo '')
          if [ -z "${REL_ID:-}" ] || [ "${REL_ID:-null}" = "null" ]; then
            echo "No published release found; skipping upload to release" >&2
            exit 0
          fi
          gh release upload "$REL_ID" tags.txt --clobber || {
            echo "Warning: failed to upload combined manifest to release $REL_ID; continuing" >&2
            exit 0
          }
